{% extends "base_old.html" %}

{% block title %}–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ - Doc-Gen-Finance35{% endblock %}

{% block content %}
<div class="hero">
    <h1>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h1>
    <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–∞—Ö Word, PDF –∏ Excel</p>
</div>

<div class="document-types">
    <div class="doc-type-card" data-type="word">
        <div class="doc-icon">üìù</div>
        <h3>Word –¥–æ–∫—É–º–µ–Ω—Ç</h3>
        <p>–°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ Microsoft Word (.docx)</p>
        <button class="btn btn-primary" onclick="showForm('word')">–°–æ–∑–¥–∞—Ç—å</button>
    </div>

    <div class="doc-type-card" data-type="pdf">
        <div class="doc-icon">üìÑ</div>
        <h3>PDF –¥–æ–∫—É–º–µ–Ω—Ç</h3>
        <p>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</p>
        <button class="btn btn-primary" onclick="showForm('pdf')">–°–æ–∑–¥–∞—Ç—å</button>
    </div>

    <div class="doc-type-card" data-type="excel">
        <div class="doc-icon">üìä</div>
        <h3>Excel —Ç–∞–±–ª–∏—Ü–∞</h3>
        <p>–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü Microsoft Excel (.xlsx)</p>
        <button class="btn btn-primary" onclick="showForm('excel')">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
</div>

<!-- –§–æ—Ä–º–∞ –¥–ª—è Word -->
<div id="form-word" class="generation-form" style="display: none;">
    <h2>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Word –¥–æ–∫—É–º–µ–Ω—Ç–∞</h2>
    <form id="word-form" enctype="multipart/form-data">
        <input type="hidden" name="doc_type" value="word">
        
        <div class="form-group">
            <label>–®–∞–±–ª–æ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <input type="file" name="template_file" accept=".docx" class="form-control">
            <small>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —à–∞–±–ª–æ–Ω Word –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞</small>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞</label>
                <input type="text" name="contract_number" class="form-control" placeholder="–î–ì-2024-001">
            </div>
            <div class="form-group">
                <label>–î–∞—Ç–∞</label>
                <input type="date" name="date" class="form-control" value="{{ today }}">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>–°—Ç–æ—Ä–æ–Ω–∞ 1 (–ó–∞–∫–∞–∑—á–∏–∫)</label>
                <input type="text" name="party1_name" class="form-control" placeholder="–û–û–û '–ö–æ–º–ø–∞–Ω–∏—è'">
            </div>
            <div class="form-group">
                <label>–°—Ç–æ—Ä–æ–Ω–∞ 2 (–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å)</label>
                <input type="text" name="party2_name" class="form-control" placeholder="–û–û–û '–°–∏—Å—Ç–µ–º–∞ –°–≤—è–∑–∏'">
            </div>
        </div>

        <div class="form-group">
            <label>–ü—Ä–µ–¥–º–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–∞</label>
            <textarea name="subject" class="form-control" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞"></textarea>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>–°—É–º–º–∞</label>
                <input type="text" name="amount" class="form-control" placeholder="500 000">
            </div>
            <div class="form-group">
                <label>–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                <input type="date" name="deadline" class="form-control">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>–ü–æ–¥–ø–∏—Å—å –∑–∞–∫–∞–∑—á–∏–∫–∞</label>
                <input type="text" name="customer_signature" class="form-control" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò.">
            </div>
            <div class="form-group">
                <label>–ü–æ–¥–ø–∏—Å—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è</label>
                <input type="text" name="executor_signature" class="form-control" placeholder="–í–µ—Å–µ–ª–µ–Ω–∫–æ –¢.–ù.">
            </div>
        </div>

        <div class="form-group">
            <label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ</label>
            <div id="word-content-editor" style="height: 200px; margin-bottom: 10px;"></div>
            <textarea name="content" class="form-control" rows="5" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞" style="display: none;"></textarea>
            <small>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞</small>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-success">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</button>
            <button type="button" class="btn btn-secondary" onclick="hideForm('word')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </form>
</div>

<!-- –§–æ—Ä–º–∞ –¥–ª—è PDF -->
<div id="form-pdf" class="generation-form" style="display: none;">
    <h2>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –¥–æ–∫—É–º–µ–Ω—Ç–∞</h2>
    <form id="pdf-form" enctype="multipart/form-data">
        <input type="hidden" name="doc_type" value="pdf">
        
        <div class="form-group">
            <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
            <input type="text" name="title" class="form-control" placeholder="–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç" required>
        </div>

        <div class="form-group">
            <label>–î–∞—Ç–∞</label>
            <input type="date" name="date" class="form-control" value="{{ today }}" required>
        </div>

        <div class="form-group">
            <label>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ</label>
            <div id="pdf-content-editor" style="height: 300px; margin-bottom: 10px;"></div>
            <textarea name="content" class="form-control" rows="8" placeholder="–¢–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞" required style="display: none;"></textarea>
            <small>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞</small>
        </div>

        <div class="form-group">
            <label>–ü–æ–¥–ø–∏—Å—å</label>
            <input type="text" name="signature" class="form-control" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò.">
        </div>

        <div class="form-group">
            <label>–¢–∞–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (JSON)</label>
            <textarea name="table_data" class="form-control" rows="6" placeholder='[["–ó–∞–≥–æ–ª–æ–≤–æ–∫1", "–ó–∞–≥–æ–ª–æ–≤–æ–∫2"], ["–î–∞–Ω–Ω—ã–µ1", "–î–∞–Ω–Ω—ã–µ2"]]'></textarea>
            <small>–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –º–∞—Å—Å–∏–≤–∞ –º–∞—Å—Å–∏–≤–æ–≤</small>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-success">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF</button>
            <button type="button" class="btn btn-secondary" onclick="hideForm('pdf')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </form>
</div>

<!-- –§–æ—Ä–º–∞ –¥–ª—è Excel -->
<div id="form-excel" class="generation-form" style="display: none;">
    <h2>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Excel —Ç–∞–±–ª–∏—Ü—ã</h2>
    <form id="excel-form" enctype="multipart/form-data">
        <input type="hidden" name="doc_type" value="excel">
        
        <div class="form-group">
            <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—á–µ—Ç–∞</label>
            <input type="text" name="title" class="form-control" placeholder="–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç" required>
        </div>

        <div class="form-group">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞</label>
            <input type="text" name="sheet_name" class="form-control" placeholder="–û—Ç—á–µ—Ç" value="–õ–∏—Å—Ç1">
        </div>

        <div class="form-group">
            <label>–¢–∞–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (JSON)</label>
            <textarea name="table_data" class="form-control" rows="10" placeholder='[["–ú–µ—Å—è—Ü", "–í—ã—Ä—É—á–∫–∞", "–†–∞—Å—Ö–æ–¥—ã"], ["–Ø–Ω–≤–∞—Ä—å", "35000", "28000"], ["–§–µ–≤—Ä–∞–ª—å", "38000", "30000"]]' required></textarea>
            <small>–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON. –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ - –∑–∞–≥–æ–ª–æ–≤–∫–∏.</small>
        </div>

        <div class="form-group">
            <label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (JSON, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <textarea name="additional_data" class="form-control" rows="4" placeholder='{"–°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞": "38333 —Ä—É–±.", "–°—Ä–µ–¥–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥—ã": "30000 —Ä—É–±."}'></textarea>
            <small>–í–≤–µ–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –æ–±—ä–µ–∫—Ç–∞</small>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-success">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Excel</button>
            <button type="button" class="btn btn-secondary" onclick="hideForm('excel')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </form>
</div>

<div id="loading" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <p>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞...</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const today = new Date().toISOString().split('T')[0];
    document.querySelectorAll('input[type="date"]').forEach(input => {
        if (!input.value) {
            input.value = today;
        }
    });

    function showForm(type) {
        document.querySelectorAll('.generation-form').forEach(form => {
            form.style.display = 'none';
        });
        document.getElementById(`form-${type}`).style.display = 'block';
        document.getElementById(`form-${type}`).scrollIntoView({ behavior: 'smooth' });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WYSIWYG —Ä–µ–¥–∞–∫—Ç–æ—Ä –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        setTimeout(() => {
            if (type === 'word' && (!window.quillEditors || !window.quillEditors['word-content-editor'])) {
                if (typeof initQuillEditor === 'function') {
                    initQuillEditor('word-content-editor', '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞...');
                }
            }
            if (type === 'pdf' && (!window.quillEditors || !window.quillEditors['pdf-content-editor'])) {
                if (typeof initQuillEditor === 'function') {
                    initQuillEditor('pdf-content-editor', '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ PDF –¥–æ–∫—É–º–µ–Ω—Ç–∞...');
                }
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
            if (typeof initDocumentPreview === 'function') {
                initDocumentPreview();
            }
        }, 200);
    }

    function hideForm(type) {
        document.getElementById(`form-${type}`).style.display = 'none';
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º
    document.getElementById('word-form').addEventListener('submit', handleSubmit);
    document.getElementById('pdf-form').addEventListener('submit', handleSubmit);
    document.getElementById('excel-form').addEventListener('submit', handleSubmit);

    function handleSubmit(e) {
        e.preventDefault();
        const form = e.target;
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º WYSIWYG –∫–æ–Ω—Ç–µ–Ω—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        if (typeof prepareFormSubmission === 'function') {
            prepareFormSubmission(form.id);
        }
        
        const formData = new FormData(form);
        
        // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –≤ production)
        console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã:', form.id);
        for (let [key, value] of formData.entries()) {
            if (key === 'content_html') {
                console.log(`${key}:`, value.substring(0, 100) + '...');
            } else {
                console.log(`${key}:`, value);
            }
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        document.getElementById('loading').style.display = 'flex';
        
        fetch('/generate', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            }
            return response.json().then(err => Promise.reject(err));
        })
        .then(blob => {
            // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = formData.get('doc_type') === 'word' ? 'document.docx' : 
                        formData.get('doc_type') === 'pdf' ? 'document.pdf' : 'document.xlsx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            document.getElementById('loading').style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            alert('–î–æ–∫—É–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–∫–∞—á–∞–Ω!');
            form.reset();
        })
        .catch(error => {
            document.getElementById('loading').style.display = 'none';
            alert('–û—à–∏–±–∫–∞: ' + (error.error || error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        });
    }
</script>
{% endblock %}

