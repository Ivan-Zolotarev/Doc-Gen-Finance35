{% extends "base_old.html" %}

{% block title %}–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ - Doc-Gen-Finance35{% endblock %}

{% block content %}
<div class="hero">
    <h1>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h1>
    <p>–°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ Word —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ PDF</p>
</div>

<div class="document-types">
    <div class="doc-type-card" data-type="word">
        <div class="doc-icon">üìù</div>
        <h3>Word ‚Üí PDF</h3>
        <p>–°–æ–∑–¥–∞–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç Word –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ª—É—á–∏—Ç–µ PDF</p>
        <button class="btn btn-primary" onclick="showForm('word')">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
</div>

<!-- –§–æ—Ä–º–∞ –¥–ª—è Word -->
<div id="form-word" class="generation-form" style="display: none;">
    <h2>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Word –¥–æ–∫—É–º–µ–Ω—Ç–∞</h2>
    <form id="word-form" enctype="multipart/form-data">
        <input type="hidden" name="doc_type" value="word">
        
        <div class="form-group">
            <label>–®–∞–±–ª–æ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <input type="file" name="template_file" accept=".docx" class="form-control">
            <small>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —à–∞–±–ª–æ–Ω Word –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞</small>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞</label>
                <input type="text" name="contract_number" class="form-control" placeholder="–î–ì-2024-001">
            </div>
            <div class="form-group">
                <label>–î–∞—Ç–∞</label>
                <input type="date" name="date" class="form-control" value="{{ today }}">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>–°—Ç–æ—Ä–æ–Ω–∞ 1 (–ó–∞–∫–∞–∑—á–∏–∫)</label>
                <input type="text" name="party1_name" class="form-control" placeholder="–û–û–û '–ö–æ–º–ø–∞–Ω–∏—è'">
            </div>
            <div class="form-group">
                <label>–°—Ç–æ—Ä–æ–Ω–∞ 2 (–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å)</label>
                <input type="text" name="party2_name" class="form-control" placeholder="–û–û–û '–°–∏—Å—Ç–µ–º–∞ –°–≤—è–∑–∏'">
            </div>
        </div>

        <div class="form-group">
            <label>–ü—Ä–µ–¥–º–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–∞</label>
            <textarea name="subject" class="form-control" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞"></textarea>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>–°—É–º–º–∞</label>
                <input type="text" name="amount" class="form-control" placeholder="500 000">
            </div>
            <div class="form-group">
                <label>–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                <input type="date" name="deadline" class="form-control">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>–ü–æ–¥–ø–∏—Å—å –∑–∞–∫–∞–∑—á–∏–∫–∞</label>
                <input type="text" name="customer_signature" class="form-control" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò.">
            </div>
            <div class="form-group">
                <label>–ü–æ–¥–ø–∏—Å—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è</label>
                <input type="text" name="executor_signature" class="form-control" placeholder="–í–µ—Å–µ–ª–µ–Ω–∫–æ –¢.–ù.">
            </div>
        </div>

        <div class="form-group">
            <label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ</label>
            <div id="word-content-editor" style="height: 200px; margin-bottom: 10px;"></div>
            <textarea name="content" class="form-control" rows="5" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞" style="display: none;"></textarea>
            <small>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞</small>
        </div>

        <div class="form-group">
            <label class="checkbox-inline">
                <input type="checkbox" name="convert_to_pdf">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–∞–∫–∂–µ –≤ PDF
            </label>
            <small>–ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Word –¥–æ–∫—É–º–µ–Ω—Ç –±—É–¥–µ—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ PDF</small>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-success">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</button>
            <button type="button" class="btn btn-secondary" onclick="hideForm('word')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </form>
</div>

<div id="loading" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <p>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞...</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const today = new Date().toISOString().split('T')[0];
    document.querySelectorAll('input[type="date"]').forEach(input => {
        if (!input.value) {
            input.value = today;
        }
    });

    function showForm(type) {
        document.querySelectorAll('.generation-form').forEach(form => {
            form.style.display = 'none';
        });
        document.getElementById(`form-${type}`).style.display = 'block';
        document.getElementById(`form-${type}`).scrollIntoView({ behavior: 'smooth' });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WYSIWYG —Ä–µ–¥–∞–∫—Ç–æ—Ä –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        setTimeout(() => {
            if (type === 'word' && (!window.quillEditors || !window.quillEditors['word-content-editor'])) {
                if (typeof initQuillEditor === 'function') {
                    initQuillEditor('word-content-editor', '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞...');
                }
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
            if (typeof initDocumentPreview === 'function') {
                initDocumentPreview();
            }
        }, 200);
    }

    function hideForm(type) {
        document.getElementById(`form-${type}`).style.display = 'none';
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã (—Ç–æ–ª—å–∫–æ Word)
    document.getElementById('word-form').addEventListener('submit', handleSubmit);

    function handleSubmit(e) {
        e.preventDefault();
        const form = e.target;
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º WYSIWYG –∫–æ–Ω—Ç–µ–Ω—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        if (typeof prepareFormSubmission === 'function') {
            prepareFormSubmission(form.id);
        }
        
        const formData = new FormData(form);
        
        // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –≤ production)
        console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã:', form.id);
        for (let [key, value] of formData.entries()) {
            if (key === 'content_html') {
                console.log(`${key}:`, value.substring(0, 100) + '...');
            } else {
                console.log(`${key}:`, value);
            }
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        document.getElementById('loading').style.display = 'flex';
        
        fetch('/generate', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            }
            return response.json().then(err => Promise.reject(err));
        })
        .then(blob => {
            // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const toPdf = formData.get('convert_to_pdf') === 'on';
            a.download = toPdf ? 'document.pdf' : 'document.docx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            document.getElementById('loading').style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            alert('–î–æ–∫—É–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–∫–∞—á–∞–Ω!');
            form.reset();
        })
        .catch(error => {
            document.getElementById('loading').style.display = 'none';
            alert('–û—à–∏–±–∫–∞: ' + (error.error || error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        });
    }
</script>
{% endblock %}

