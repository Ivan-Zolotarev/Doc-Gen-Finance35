{% extends "base.html" %}

{% block title %}–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ë–î - Doc-Gen-Finance35{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üóÑÔ∏è –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö</h1>
    <p>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ö–µ–º, ER-–¥–∏–∞–≥—Ä–∞–º–º –∏ –æ–ø–∏—Å–∞–Ω–∏–π —Ç–∞–±–ª–∏—Ü</p>
</div>

<div class="tabs">
    <button class="tab-btn active" onclick="showTab('sql')">SQL —Ñ–∞–π–ª</button>
    <button class="tab-btn" onclick="showTab('connection')">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î</button>
</div>

<!-- –§–æ—Ä–º–∞ –¥–ª—è SQL —Ñ–∞–π–ª–∞ -->
<div id="tab-sql" class="tab-content active">
    <div class="upload-card">
        <h2>–ê–Ω–∞–ª–∏–∑ SQL —Ñ–∞–π–ª–∞</h2>
        <form id="sql-form" enctype="multipart/form-data">
            <input type="hidden" name="db_type" value="sql_file">
            
            <div class="form-group">
                <label>SQL —Ñ–∞–π–ª</label>
                <input type="file" name="sql_file" accept=".sql" class="form-control" required>
                <small>–ó–∞–≥—Ä—É–∑–∏—Ç–µ SQL —Ñ–∞–π–ª —Å CREATE TABLE –∏ –¥—Ä—É–≥–∏–º–∏ DDL –∫–æ–º–∞–Ω–¥–∞–º–∏</small>
            </div>

            <div class="form-group">
                <label>–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞</label>
                <select name="format" class="form-control">
                    <option value="markdown">Markdown –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</option>
                    <option value="mermaid">ER-–¥–∏–∞–≥—Ä–∞–º–º–∞ (Mermaid)</option>
                </select>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-success">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é</button>
            </div>
        </form>
    </div>
</div>

<!-- –§–æ—Ä–º–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
<div id="tab-connection" class="tab-content">
    <div class="upload-card">
        <h2>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</h2>
        <form id="connection-form" enctype="multipart/form-data">
            <input type="hidden" name="db_type" value="connection">
            
            <div class="form-group">
                <label>–°—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</label>
                <input type="text" name="connection_string" class="form-control" 
                       placeholder="postgresql://user:password@localhost/dbname" required>
                <small>–ü—Ä–∏–º–µ—Ä—ã:<br>
                PostgreSQL: postgresql://user:pass@localhost/dbname<br>
                MySQL: mysql://user:pass@localhost/dbname<br>
                SQLite: sqlite:///path/to/database.db</small>
            </div>

            <div class="form-group">
                <label>–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞</label>
                <select name="format" class="form-control">
                    <option value="markdown">Markdown –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</option>
                    <option value="mermaid">ER-–¥–∏–∞–≥—Ä–∞–º–º–∞ (Mermaid)</option>
                </select>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-success">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é</button>
            </div>
        </form>
    </div>
</div>

<div id="loading" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <p>–ê–Ω–∞–ª–∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏...</p>
</div>

<div class="info-box">
    <h3>–ß—Ç–æ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ?</h3>
    <ul>
        <li>üìä –û–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü</li>
        <li>üîë –ü–µ—Ä–≤–∏—á–Ω—ã–µ –∏ –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏</li>
        <li>üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–ª–æ–Ω–æ–∫ –∏ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö</li>
        <li>üîó –°–≤—è–∑–∏ –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏</li>
        <li>üìà ER-–¥–∏–∞–≥—Ä–∞–º–º—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ Mermaid</li>
        <li>üìë –ò–Ω–¥–µ–∫—Å—ã –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è</li>
    </ul>
</div>
{% endblock %}

{% block extra_js %}
<script>
function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.getElementById(`tab-${tabName}`).classList.add('active');
    event.target.classList.add('active');
}

document.getElementById('sql-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    document.getElementById('loading').style.display = 'flex';
    
    fetch('/generate-db-docs', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        return response.json().then(err => Promise.reject(err));
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const format = formData.get('format');
        a.download = format === 'mermaid' ? 'db_diagram.mmd' : 'db_docs.md';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        document.getElementById('loading').style.display = 'none';
        alert('–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ë–î —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞!');
    })
    .catch(error => {
        document.getElementById('loading').style.display = 'none';
        alert('–û—à–∏–±–∫–∞: ' + (error.error || error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    });
});

document.getElementById('connection-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    document.getElementById('loading').style.display = 'flex';
    
    fetch('/generate-db-docs', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        return response.json().then(err => Promise.reject(err));
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const format = formData.get('format');
        a.download = format === 'mermaid' ? 'db_diagram.mmd' : 'db_docs.md';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        document.getElementById('loading').style.display = 'none';
        alert('–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ë–î —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞!');
    })
    .catch(error => {
        document.getElementById('loading').style.display = 'none';
        alert('–û—à–∏–±–∫–∞: ' + (error.error || error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    });
});
</script>
{% endblock %}

